---
---

```{r setup, include = FALSE}
source(here::here("R", "document_setup.R"))

htmltools::tagList(rmarkdown::html_dependency_font_awesome())
```

```{r functions}
source(here("R", "load.R"))
source(here("R", "html.R"))
```

```{r load}
dataset_files <- fs::dir_ls(here("data", "datasets"), glob = "*.csv")

datasets <- get_datasets(dataset_files)
```

```{r dashboard}
tags <- htmltools::tags

tags$div(
    class = "row",
    tags$div(
        class = "col-md-4",
        value_box(nrow(datasets), caption = "Datasets", colour = "success",
                  icon = "database")
    ),
    tags$div(
        class = "col-md-4",
        value_box(length(unique(datasets$organ)), caption = "Organs",
                         colour = "info", icon = "user")
    ),
    tags$div(
        class = "col-md-4",
        value_box(scales::comma(sum(datasets$ncells)),
                  caption = "Cells", colour = "warning", icon = "splotch")
    )
)
```

```{r counts, fig.height = 10}
plot_data <- datasets %>%
    group_by(animal, organ) %>%
    summarise(
        Datasets = n(),
        Cells    = sum(ncells),
        .groups  = "drop"
    ) %>%
    mutate(organ = fct_reorder(organ, Cells, sum)) %>%
    pivot_longer(
        c(Datasets, Cells),
        names_to = "Type",
        values_to = "Number"
    )

ggplot(plot_data, aes(x = organ, y = Number, fill = animal)) +
    geom_col(position = position_dodge2(preserve = "single")) +
    scale_y_continuous(labels = scales::label_comma(accuracy = 1)) +
    scale_fill_manual(values = c(human = "#F39C12", mouse = "#3498DB")) +
    coord_flip() +
    facet_wrap(~ Type, scales = "free_x") +
    theme(
        text               = element_text(colour = "#2C3E50"),
        legend.position    = "bottom",
        legend.title       = element_blank(), 
        axis.title         = element_blank(),
        axis.text          = element_text(colour = "#2C3E50"),
        strip.background   = element_rect(fill = "#2C3E50"),
        strip.text         = element_text(colour = "white", size = 16),
        panel.border       = element_rect(fill = NA),
        panel.grid         = element_blank(),
        panel.grid.major.x = element_line(colour = "#2C3E50")
    )
```

Table
-----

```{r table}
tbl <- datasets %>%
    reactable::reactable(
        defaultSorted       = "id",
        defaultSortOrder    = "asc",
        defaultColDef       = reactable::colDef(
            class       = "cell",
            headerClass = "header",
            headerStyle = list(fontWeight = 700)
        ),
        defaultColGroup = reactable::colGroup(headerClass = "group-header"),
        compact             = TRUE,
        highlight           = TRUE,
        showSortIcon        = FALSE,
        borderless          = TRUE,
        striped             = TRUE,
        showPageSizeOptions = TRUE,
        class               = "custom-table",
        columns = list(
            id = reactable::colDef(name = "ID"),
            animal = reactable::colDef(
                name       = "Animal",
                filterable = TRUE
            ),
            organ = reactable::colDef(
                name       = "Organ",
                filterable = TRUE
            ),
            subtissue = reactable::colDef(
                name       = "Sub-tissue",
                filterable = TRUE
            ),
            ncells = reactable::colDef(name  = "Cells"),
            protocol = reactable::colDef(
                name       = "Protocol",
                filterable = TRUE
            ),
            counts = reactable::colDef(name = "Counts"),
            has_celltypes = reactable::colDef(
                name       = "Has cell types?",
                filterable = TRUE
            ),
            lab = reactable::colDef(name = "Lab"),
            year = reactable::colDef(name = "Year")
        )
    )

htmltools::div(class = "custom-table-container", tbl)
```

